name: Release

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-release:
    name: Build and release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version from release tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update version in Cargo.toml
        run: |
          echo "Updating version to ${{ steps.get_version.outputs.VERSION }}"
          sed -i '/\[workspace\.package\]/,/^\[/ s/^version = "0\.0\.0"$/version = "${{ steps.get_version.outputs.VERSION }}"/' Cargo.toml
          echo "Updated Cargo.toml workspace.package section:"
          sed -n '/\[workspace\.package\]/,/^\[/p' Cargo.toml | grep "version ="

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Install musl tools
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-musl-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-musl-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-musl-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      # Tests are not run here because:
      # 1. Releases are only created from the main branch
      # 2. All code must pass tests (test.yml) before merging to main
      # 3. Running tests here would require Gitea setup (docker-tests feature)

      - name: Build static binary
        run: |
          cargo build --release --target x86_64-unknown-linux-musl -p k-releaser
          strip target/x86_64-unknown-linux-musl/release/k-releaser

      - name: Create release archive
        run: |
          cd target/x86_64-unknown-linux-musl/release
          tar -czf k-releaser-${{ steps.get_version.outputs.VERSION }}-x86_64-linux-musl.tar.gz k-releaser
          sha256sum k-releaser-${{ steps.get_version.outputs.VERSION }}-x86_64-linux-musl.tar.gz > k-releaser-${{ steps.get_version.outputs.VERSION }}-x86_64-linux-musl.tar.gz.sha256

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/x86_64-unknown-linux-musl/release/k-releaser-${{ steps.get_version.outputs.VERSION }}-x86_64-linux-musl.tar.gz
            target/x86_64-unknown-linux-musl/release/k-releaser-${{ steps.get_version.outputs.VERSION }}-x86_64-linux-musl.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update major version tag
        run: |
          # Extract major version from tag (e.g., v1.1.8 -> v1)
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "Full tag: $TAG_NAME"

          # Extract major version (handles both vX.Y.Z and X.Y.Z formats)
          if [[ $TAG_NAME =~ ^v?([0-9]+)\. ]]; then
            MAJOR_VERSION="${BASH_REMATCH[1]}"
            MAJOR_TAG="v${MAJOR_VERSION}"
            echo "Major version tag: $MAJOR_TAG"

            # Configure git
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Create or update the major version tag
            git tag -fa "$MAJOR_TAG" -m "Update $MAJOR_TAG to $TAG_NAME"
            git push origin "$MAJOR_TAG" --force

            echo "✓ Updated $MAJOR_TAG to point to $TAG_NAME"
          else
            echo "⚠ Could not extract major version from $TAG_NAME"
            exit 1
          fi
